<?php
include "./inc/header.html";

$select_idx = ($copyidx != "") ? $copyidx : $idx;

$sql= "SELECT * FROM analysis_report WHERE idx= '$select_idx'";
$result = mysqli_query($gconnet, $sql) or error('error');
$report_info = mysqli_fetch_array($result);

$sql = "SELECT * FROM DM_option WHERE idx = '$select_idx'";
$result = mysqli_query($gconnet, $sql) or error('option error');
$opt_info = mysqli_fetch_array($result);

// 중분류
$model_list = array(1=>array(), 2=>array(), 3=>array(), 4=>array(), 5=>array());
?>
<script>
    $(document).ready(function() {
        $(".sec_con li").on("click", function() {
            /*
            var chk = ($(this).find("input[type='checkbox']").prop("checked")) ? false : true;
            $(this).find("input[type='checkbox']").prop("checked", chk);
            */
        });
        $("#btnReportCreate").on("click", function() {
            submitFrom("report_insert");
        });

        $("#btnReportTemporary").on("click", function() {
            submitFrom("report_temporary");
        });

        $(".txtWeight").on("keyup", function() {
            setWeightTotal();
        });
    })

    function submitFrom(mode) {

        var formData = new FormData($("#reportFrm")[0]);

        formData.append("mode", mode);

        $.ajax({
            type: 'POST',
            url: 'multi_act.php',
            processData: false, // 필수
            contentType: false, // 필수
            data: formData,
            success: function(data) {
                var result = data.split("|");
                if(result[0] == "OK") {
                    if(mode == "report_insert") {
                        alert('모델 생성을 완료하였습니다. 보고서 생성 시 시간이 소요될 수 있습니다. 안내문구 추가 사항 필요');
                        document.location = "my_report.html";
                    } else if(mode == "report_temporary") {
                        alert("임시 저장하였습니다.");
                        return false;
                    }
                } else if (result[0] == "ERR") {
                    alert(result[1]);
                } else {
                    alert(data);
                }
            }
        });

    }

    function btnPlusOption(element){
        var elementId = element.id;
        var checkboxes = document.getElementsByName('quiz_list');

        if($('input:checkbox[name="quiz_list"]:checked').length > 1){
            alert("하나만 선택해주세요.");
            for(var i=0; i<checkboxes.length; i++){
                checkboxes[i].checked = false;
            }
        }else {
            var query = $('input:checkbox[name="quiz_list"]:checked').attr("id");
            $("input[name='"+elementId+"']").val($('label[for="' + query + '"]').text());
            for(var i=0; i<checkboxes.length; i++){
                checkboxes[i].checked = false;
            }
        }

        //var inp = document.getElementsByTagName("input");
        //for(var i=0; i<inp.length; i++){
        //    if(inp[i].type == 'checkbox'){
        //        inp[i].checked = false;
        //    }
        //}
    }

    function setOptionQuiz(optId) {

        if($('input:checkbox[name="quiz_list"]:checked').length <= 0){
            alert("문항을 선택해주세요.");
        } else if($('input:checkbox[name="quiz_list"]:checked').length > 1){
            alert("문항을 하나만 선택해주세요.");
            $("input[name='quiz_list']").prop("checked", false);
        } else {

            var quiz_no = $("input[name='quiz_list']:checked").val();
            var quiz_txt = $("label[for='"+$("input[name='quiz_list']:checked").attr("id")+"']").text();

            $("input[name='"+optId+"']").val(quiz_no);
            $("#txt_"+optId).val(quiz_txt);

            if(optId.includes('[')) {   // group
                var txtId = optId.replace("[", "_").replace("]", "");
                $("#txt_"+txtId).val(quiz_txt);

                var tmpIdArray = txtId.split("_");
                if(tmpIdArray[0] == "itemIdx") {
                    $("input[name='selectedItemNM["+tmpIdArray[1]+"]']").val(quiz_txt);
                }
            }

            if(optId.includes('case_quiz_no') && $("input[name='quiz_list']:checked").attr("exlist") != "") {   // case example
                var optIdList = txtId.split("_");
                var optIdNo = optIdList[optIdList.length-1];
                var exlist = $("input[name='quiz_list']:checked").attr("exlist").split("^");
                var caseExList = $("#case_ex_list_" + optIdNo);
                caseExList.find("li").remove();
                for(ii = 0; ii < exlist.length; ii++) {
                    var detailList = exlist[ii].split("|");
                    caseExList.append("<li><input type='checkbox' name='case_item_details["+optIdNo+"][]' value='"+detailList[0]+"'> "+detailList[1]+"</li>");
                }
            }
            $("input[name='quiz_list']").prop("checked", false);

        }

    }

    function resetOptionQuiz(optId) {
        $("input[name='"+optId+"']").val("");
        $("#txt_"+optId).val("");

        if(optId.includes('[')) {
            var txtId = optId.replace("[", "_").replace("]", "");
            $("#txt_"+txtId).val("");

            var tmpIdArray = txtId.split("_");
            if(tmpIdArray[0] == "itemIdx") {    // group
                $("input[name='selectedItemNM["+tmpIdArray[1]+"]']").val('');
            }
        }

        if(optId.includes('case_quiz_no')) {   // case example
            var optIdList = txtId.split("_");
            var optIdNo = optIdList[optIdList.length-1];
            var caseExList = $("#case_ex_list_" + optIdNo);
            caseExList.find("li").remove();
        }

    }

    function setModelQuiz(modelId) {

        if($('input:checkbox[name="quiz_list"]:checked').length <= 0){
            alert("문항을 선택해주세요.");
        } else {

            $("input:checkbox[name='quiz_list']:checked").each(function() {

                var quiz_no = $(this).val();
                var quiz_txt = $("label[for='"+$(this).attr("id")+"']").text();

                var id_list = modelId.split("_");
                var sub_id = "sub_" + modelId;

                var quiz_chk = false;
                $("#"+modelId).find("input[name='middle_model_sub_quizno["+id_list[2]+"]["+id_list[3]+"][]']").each(function() { // 같은 문항 선택 시 추가하지 않음
                    if(quiz_no == $(this).val()) {
                        quiz_chk = true;
                        return false;
                    }
                });

                if(quiz_chk == false) {

                    $("#"+modelId).append('<div class="rows" id="'+sub_id+'"></div>');
                    $("#"+modelId).find(".rows:last").append('    <li class="card-contents1"></li>');
                    $("#"+modelId).find(".rows:last").find(".card-contents1").append('    <input type="hidden" name="middle_model_sub_quizno['+id_list[2]+']['+id_list[3]+'][]" value="'+quiz_no+'">');
                    $("#"+modelId).find(".rows:last").find(".card-contents1").append('        <div></div>');
                    $("#"+modelId).find(".rows:last").find(".card-contents1").find("div").append('            <button class="delete" type="button" onclick="deleteModelQuiz(\''+sub_id+'\')">x</button>');
                    $("#"+modelId).find(".rows:last").find(".card-contents1").find("div").append('            <span>'+quiz_txt+'</span>');
                    $("#"+modelId).find(".rows:last").append('    <li class="card-contents2"><input type="text" class="txtDistributionGrade'+id_list[2]+'" name="distribution['+id_list[2]+']['+id_list[3]+'][]"></li>');

                    $("#use_grade"+id_list[2]+"_middle_model_check").prop("checked", true);
                    $("#use_grade"+id_list[2]+"_middle_model_"+id_list[3]+"_check").prop("checked", true);

                }

            });

            $("input[name='quiz_list']").prop("checked", false);
        }

    }

    function deleteModelQuiz(id) {
        $("#"+id).remove();
    }

    function setModdleModelTitle(no, title) {
        $(".middleModelArea").each(function() {
            $(this).find(".moddleModelTitle:eq("+(no-1)+")").val(title);
        });

        if(title == "") title = "중분류 " + no;
        $(".table-weight-tdTit:eq("+(no - 1)+")").html(title);
    }

    function setDistribution(grade, no) {
        $(".txtDistributionGrade" + grade).each(function() {
            $(this).val($("input[name='same_distribution_grade"+grade+"_"+no+"']").val());
        });
    }

    function setWeight() {
        $(".txtWeight").each(function() {
            $(this).val($("input[name='same_weight']").val());
        });
        setWeightTotal();
    }

    function setWeightTotal() {
        for(model_index = 1; model_index <= <?=count($model_list)?>; model_index++) {
            var weight_total = 0;
            $(".txtWeight[model_index='"+model_index+"']").each(function() {
                if($(this).val() != "") weight_total += parseFloat($(this).val());
            });
            $("#weight_total_" + model_index).html(weight_total);
        }
    }
</script>

<div id="container">
    <div id="textWrap" class="textWrap2">
        <h2 class="title">다면평가모델 생성</h2>
        <p class="description">
            <!--Lorem ipsum dolor sit amet consectetur adipisicing elit. Fuga laborum, atque eos cupiditate molestiae sint placeat laudantium reprehenderit.-->
        </p>
    </div>
    <main>
        <form id="reportFrm" action="" enctype="multipart/form-data" onsubmit="return false">
            <input type="hidden" name="report_idx" value="<?=$idx?>">
            <div class="div_right" id="list">
                <?php
                    include "./inc/right.php";
                    ?>
            </div>
            <div class="div_left">
                <div class="original-bg-style margin50">
                    <div onclick="fnScrollTop('section1')" class="sec_title contentsTop">
                        <h2 class="stepTit">
                            <span class="stepBadge active">STEP 1</span>
                            <br />조사정보입력
                            <div class="announce announce-light">
                                <p>STEP1 기입 내용은 보고서의 '조사정보'란에 출력됩니다.</p>
                            </div>
                            <!--<i class="bi bi-bar-chart-steps"></i>-->
                        </h2>
                    </div>
                    <section id="section1">
                        <div class="infobox">
                            <div class="announce"><i class="bi bi-exclamation-circle"></i> 보고서 생성을 위한 <span class="fontcolor-red">필수 항목</span>들은 반드시 입력해주세요.</div>
                        </div>
                        <table class="table-step table-step1">
                            <tr>
                                <td>
                                    <div class="input-group essential-item">
                                        <label for="analysis_title" class="input-group-text w130"> 보고서명 </label>
                                        <input type="text" class="form-control" name="analysis_title" id="analysis_title" placeholder="ex) 20XX년 와이즈인컴퍼니 다면평가" value="<?=$report_info['analysis_title']?>" />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <label for="population" class="input-group-text w130"> 모집단 </label>
                                        <input type="text" class="form-control" name="population" id="population" placeholder="ex) 2020년 현재 와이즈인컴퍼니 전직원(00명)" value="<?=$report_info['population']?>" />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <label for="sample_size" class="input-group-text w130"> 표본크기 </label>
                                        <input type="text" class="form-control" name="sample_size" id="sample_size" placeholder="ex) 총 00명 (a팀: 0명, b팀: 0명, c팀: 0명)" value="<?=$report_info['sample_size']?>" />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <label for="sampling_method" class="input-group-text w130"> 표본추출방법 </label>
                                        <input type="text" class="form-control" name="sampling_method" id="sampling_method" placeholder="ex) 전수조사" value="<?=$report_info['sampling_method']?>" />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <label for="survey_method" class="input-group-text w130"> 조사방법 </label>
                                        <input type="text" class="form-control" name="survey_method" id="survey_method" placeholder="ex) 온라인/모바일 조사" value="<?=$report_info['survey_method']?>" />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <label for="analysis_period" class="input-group-text w130"> 조사기간 </label>
                                        <input type="text" class="form-control" name="analysis_period" id="analysis_period" placeholder="ex) 20XX년 XX월 XX일 ~ 20XX년 XX월 XX일" value="<?=$report_info['analysis_period']?>" />
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group essential-item">
                                        <span class="input-group-text w130 m10 border-right"> 평가자</span>
                                        <input type="hidden" name="appraiser_no" value="<?=$opt_info['APPRAISER_NO']?>">
                                        <input type="text" class="text-disabled input-border w300" id="txt_appraiser_no" placeholder="문항리스트에서 추가하세요" value="<?=$quiz_list[$opt_info['APPRAISER_NO']]?>" disabled/>
                                        <button type="button" class="btn-secondary btn-plus" id="btn_appraiser_no" onclick="setOptionQuiz('appraiser_no')">+</button>
                                        <button class="btn-outline-secondary btn-minus" onclick="resetOptionQuiz('appraiser_no')">-</button>
                                        <span class="announce announce-light">문항리스트에서 평가자 항목을 선택·추가합니다.</span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group essential-item">
                                        <span class="input-group-text w130 m10 border-right"> 피평가자</span>
                                        <input type="hidden" name="marymondyum" value="<?=$opt_info['MARYMONDYUM']?>">
                                        <input type="text" class="text-disabled input-border w300" id="txt_marymondyum" placeholder="문항리스트에서 추가하세요" value="<?=$quiz_list[$opt_info['MARYMONDYUM']]?>" disabled/>
                                        <button class="btn-secondary btn-plus" id="btn_marymondyum" onclick="setOptionQuiz('marymondyum')">+</button>
                                        <button class="btn-outline-secondary btn-minus" onclick="resetOptionQuiz('marymondyum')">-</button>
                                        <span class="announce announce-light">문항리스트에서 피평가자 항목을 선택·추가합니다.</span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group essential-item">
                                        <span class="input-group-text w130 m10 border-right"> 평가대상구분</span>
                                        <input type="hidden" name="appraiser" value="<?=$opt_info['APPRAISER']?>">
                                        <input type="text" class="text-disabled input-border w300" id="txt_appraiser" placeholder="문항리스트에서 추가하세요" value="<?=$quiz_list[$opt_info['APPRAISER']]?>" disabled/>
                                        <button class="btn-secondary btn-plus" id="btn_appraiser" onclick="setOptionQuiz('appraiser')">+</button>
                                        <button class="btn-outline-secondary btn-minus" onclick="resetOptionQuiz('appraiser')">-</button>
                                        <span class="announce announce-light">문항리스트에서 평가자와 피평가자의 관 항목을 선택·추가합니다.</span>
                                    </div>
                                </td>
                            </tr>
                            <tr class="tr-margin"></tr>
                            <?php
                                    $group_list = array(1=>array(), 2=>array(), 3=>array(), 4=>array());

                            $sql = "SELECT * FROM DM_group WHERE idx = '$select_idx' ORDER BY groupIdx ASC, itemIdx ASC";
                            $result = mysqli_query($gconnet, $sql);
                            while($row = mysqli_fetch_array($result)) {
                            $group_list[$row['groupIdx']] = $row;
                            }
                            if(is_array($group_list)) {
                            foreach($group_list as $ii => $grp_row) {
                            ?>
                            <tr id="groupClassification">
                                <td>
                                    <div class="input-group">
                                        <span class="input-group-text w130 m10 border-right"> 집단구분항목 <?=$ii?></span>
                                        <input type="hidden" name="itemIdx[<?=$ii?>]" value="<?=$grp_row['itemIdx']?>">
                                        <input type="text" class="text-disabled input-border w300" id="txt_itemIdx_<?=$ii?>" value="<?=$quiz_list[$grp_row['itemIdx']]?>" placeholder="문항리스트에서 추가하세요" disabled/>
                                        <input type="text" class="form-control input-border w130" name="selectedItemNM[<?=$ii?>]" value="<?=$grp_row['selectedItemNM']?>" placeholder="집단구분항목명을 입력하세요." />
                                        <button class="btn-secondary btn-plus" id="btn_temIdx_<?=$ii?>" onclick="setOptionQuiz('itemIdx[<?=$ii?>]')">+</button>
                                        <button class="btn-outline-secondary btn-minus" onclick="resetOptionQuiz('itemIdx[<?=$ii?>]')">-</button>

                                    </div>
                                </td>
                            </tr>
                            <?php
                                        }
                                    }
                                    ?>
                            <!--
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <button type="button" onclick="addGroup(this)" class="btn-secondary btn-plus" id="btnPlusGroup">+</button>
                                    </div>
                                </td>
                            </tr>
                            -->

                            <tr>
                                <td>
                                    <div class="announce announce-light">
                                        <p>
                                        <ul>
                                            <li>집단구분항목은 다면평가 결과를 집단별로 분석하는 기준변수입니다. <span class="fontcolor-red">문항리스트에서 선택해주세요.</span></li>
                                            <li>하위 집단의 수가 최소 30표본 이상이 되도록 구성하시기 바랍니다. (예: 20대: 30명, 30대: 50명 O / 20대: 4명, 30대: 15명 X)</li>
                                        </ul>
                                        </p>
                                    </div>
                                </td>
                            </tr>

                            <tr class="tr-margin"></tr>
                            <?php
                                    $case_list = array(1 => array(), 2 => array());
                            $sql = "SELECT * FROM DM_sample_case WHERE idx = '$select_idx'";
                            $result = mysqli_query($gconnet, $sql);
                            unset($tmp_grp_idx); $case_no = 0;
                            while($row = mysqli_fetch_array($result)) {

                            if($tmp_grp_idx != $row['groupIdx']) {
                            $case_no++;
                            }

                            $case_list[$case_no]['grp'] = $row['groupIdx'];
                            $case_list[$case_no]['item'][$row['itemDetailsIndex']] = true;

                            $tmp_grp_idx = $row['groupIdx'];
                            }
                            if(is_array($case_list)) {
                            foreach($case_list as $case_no => $case_row) {
                            ?>
                            <tr id="groupClassification">
                                <td>
                                    <div class="input-group">
                                        <span class="input-group-text w130 m10 border-right"> 케이스 <?=$case_no?></span>
                                        <input type="hidden" name="case_quiz_no[<?=$case_no?>]" value="<?=$case_row['grp']?>">
                                        <input type="text" class="text-disabled input-border w300" id="txt_case_quiz_no_<?=$case_no?>" value="<?=$quiz_list[$case_row['grp']]?>" placeholder="문항리스트에서 추가하세요" disabled/>
                                        <button class="btn-secondary btn-plus" id="btn_case_quiz_no_<?=$case_no?>" onclick="setOptionQuiz('case_quiz_no[<?=$case_no?>]')">+</button>
                                        <button class="btn-outline-secondary btn-minus" onclick="resetOptionQuiz('case_quiz_no[<?=$case_no?>]')">-</button>

                                        <ul id="case_ex_list_<?=$case_no?>" class="case-style">
                                            <?php
                                                if(is_array($quiz_value_list[$case_row['grp']])) {
                                                    foreach($quiz_value_list[$case_row['grp']] as $val_ii => $val_txt) {
                                            list($val_value, $val_title) = explode("|", $val_txt);

                                            $chk = ($case_list[$case_no]['item'][$val_value]) ? "checked" : "";
                                            ?>
                                            <li><input type='checkbox' name='case_item_details[<?=$case_no?>][]' value='<?=$val_value?>' <?=$chk?>> <?=$val_title?></li>
                                            <?php
                                                    }
                                                }
                                                ?>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            <?php
                                        }
                                    }
                                    ?>
                            <tr>
                                <td>
                                    <div class="announce announce-light">
                                        <p>
                                        <ul>
                                            <li>케이스는 분석데이터의 기준변수입니다. <span class="fontcolor-red">문항리스트에서 선택해주세요.</span></li>
                                            <li>문항 선택 후 보기를 선택하시기 바랍니다. (예: 20대, 30대 선택 시 20대, 30대 데이터만 분석됩니다.)</li>
                                        </ul>
                                        </p>
                                    </div>
                                </td>
                            </tr>

                            <tr class="tr-margin"></tr>
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <span class="input-group-text w130 m10 border-right">로고등록</span>
                                        <input type="file" class="form-control w600 border-left" name="log_path" />
                                    </div>
                                    <div class="announce announce-light">
                                        <p>자사의 로고를 업로드해보세요. 나만의 보고서가 완성됩니다.<span class="fontcolor-blue">로고등록된 보고서 보기</span></p>
                                        <ul>
                                            <li>로고 이미지 (가로 640픽셀 이상, 16:9 비율 권장, 용량 2KB 이하)</li>
                                            <li>업로드 이미지 형식: JPG, GIF, PNG</li>
                                        </ul>
                                        <p></p>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </section>
                </div>
                <div class="original-bg-style margin50">
                    <div onclick="fnScrollTop('section2')" class="sec_title sec_title2 contentsTop">
                        <h2 class="stepTit">
                            <span class="stepBadge">STEP 2</span>
                            <br />분석모델설정
                            <!--<i class="bi bi-bar-chart-steps"></i>-->
                        </h2>
                    </div>
                    <section id="section2">
                        <div class="infobox">
                            <!--<div class="announce"><i class="bi bi-exclamation-circle"></i> <span class="fontcolor-red">분석모델설정</span> 분석모델설정 설명 문구 들어가는 부분입니다.</div>-->
                            <div class="announce"><i class="bi bi-exclamation-circle"></i> <span class="fontcolor-red">중분류</span> 조사문항 중 유사한 문항을 묶어 분류해 놓은 것입니다.</div>
                            <div class="announce"><i class="bi bi-exclamation-circle"></i> <span class="fontcolor-red">배점</span> 각 항목별 배점을 설정합니다.</div>
                        </div>
                        <table class="table-step table-step2">
                            <?php
                                    if($mode != "new" || $copyidx != "") {
                                        $sql = "SELECT * FROM DM_middle_model WHERE idx = '$select_idx' ORDER BY middle_model_index ASC";
                                        $result = mysqli_query($gconnet, $sql);
                                        while($row = mysqli_fetch_array($result)) {
                                            $model_list[$row['middle_model_index']] = $row;
                                        }
                                    }
                                    if(is_array($model_list)) {
                                        foreach($model_list as $ii => $mdl_list) {
                            ?>
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <span class="input-group-text w130 m10 border-right"> 중분류 <?=$ii?></span>
                                        <input type="text" class="form-control input-border w130" name="middle_model_name[<?=$ii?>]" value="<?=$mdl_list['middle_model_name']?>" placeholder="중분류명을 입력하세요." onkeyup="setModdleModelTitle('<?=$ii?>', $(this).val())" />
                                    </div>
                                </td>
                            </tr>
                            <?php
                                        }
                                    }

                                    // DM_middle_model_sub
                                    unset($middle_model_sub_list);
                                    $sql = "SELECT * FROM DM_middle_model_sub WHERE idx = '$select_idx'";
                                    $result = mysqli_query($gconnet, $sql);
                                    while($row = mysqli_fetch_array($result)) {
                                        $distribution_list[$row['appraisee_grade']][$row['middle_model_index']][$row['quiz_no']] = $row['distribution'];
                                    }
                                    ?>
                            <?php
                                    $grade = 1; // 피평가자 등급
                                    $use_grade_chk = (is_array($distribution_list[$grade])) ? "checked" : "";
                                    ?>
                            <tr class="tr-margin"></tr>
                        </table>
                        <table class="table-step table-step2">
                            <tr>
                                <td>
                                    <div class="accordion" id="accordionPanelsStayOpenExample">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="flush-headingOne">
                                                <a class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                                                <span class="marymondyum-group-title m10">
                                                    <input class="form-check-input mt-0 m5" id="use_grade<?=$grade?>_middle_model_check" name="use_grade[]" value="<?=$grade?>" type="checkbox" <?=$use_grade_chk?>>상사
                                                </span>
                                                <div class="step2-optionGroup">
                                                    <span class="step2-optionGroup-label">동일배점</span>
                                                    <div class="input-group points-input-group">
                                                        <input type="text" name="same_distribution_grade<?=$grade?>_<?=$ii?>" class="form-control points-form" placeholder="배점입력">
                                                        <button class="btn btn-outline-secondary btn-apply border-right" type="button" onclick="setDistribution('<?=$grade?>', '<?=$ii?>')">적용</button>
                                                        <span class="announce announce-light">문항별 배점을 일괄 등록할 수 있습니다.</span>
                                                    </div>
                                                </div>
                                                </a>
                                            </h2>
                                            <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                                                <div class="accordion-body">
                                                    <?php
                                                    for($ii = 1; $ii <= 5; $ii++) {
                                                        $model_quiz_id = "model_quiz_".$grade."_".$ii;
                                                        $use_chk = (is_array($distribution_list[$grade][$ii])) ? "checked" : "";
                                                    ?>
                                                    <div class="card">
                                                        <div class="card-body">
                                                            <div class="card-content-wrap">
                                                                <ul class="column1">
                                                                    <li class="card-tit">중분류 <?=$ii?></li>
                                                                    <li class="card-contents">
                                                                        <input type="text" class="moddleModelTitle" value="<?=$model_list[$ii]['middle_model_name']?>" placeholder="중분류 제목" readonly />
                                                                    </li>
                                                                </ul>
                                                                <ul class="column2">
                                                                    <ul>
                                                                        <li class="card-tit">문항선택</li>
                                                                        <li class="card-tit">배점입력</li>
                                                                    </ul>
                                                                    <ul id="<?=$model_quiz_id?>">
                                                                        <?php
                                                                        $sub_list = $distribution_list[$grade][$ii];
                                                                        if(is_array($sub_list)) {
                                                                        foreach($sub_list as $sub_quizno => $sub_distribution) {
                                                                        $sub_id = "middle_model_sub_".$grade."_".$ii."_".$sub_quizno;
                                                                        ?>
                                                                        <div class="rows" id="<?=$sub_id?>">
                                                                            <li class="card-contents1">
                                                                                <input type="hidden" name="middle_model_sub_quizno[<?=$grade?>][<?=$ii?>][]" value="<?=$sub_quizno?>">
                                                                                <div>
                                                                                    <button class="delete" type="button" onclick="deleteModelQuiz('<?=$sub_id?>')">x</button>
                                                                                    <span><?=$quiz_list[$sub_quizno]?></span>
                                                                                </div>
                                                                            </li>
                                                                            <li class="card-contents2"><input type="text" class="txtDistributionGrade<?=$grade?>" name="distribution[<?=$grade?>][<?=$ii?>][]" value="<?=$sub_distribution?>"></li>
                                                                        </div>
                                                                        <?php
                                                                            }
                                                                         }
                                                                        ?>
                                                                    </ul>
                                                                </ul>
                                                            </div>
                                                            <div class="card-action-wrap">
                                                                <div class="card-action-left">
                                                                    <input type="checkbox" id="use_grade<?=$grade?>_middle_model_<?=$ii?>_check" name="use_grade<?=$grade?>_middle_model[]" value="<?=$ii?>" class="useMiddleModel" title="중분류 사용여부" <?=$use_chk?>>
                                                                    <label for="use_grade<?=$grade?>_middle_model_<?=$ii?>_check">중분류 <?=$ii?>를 사용합니다</label>
                                                                </div>
                                                                <div class="card-action-right">
                                                                    <button id="btn_plus_<?=$model_quiz_id?>" class="btn-secondary btn-plus-small" onclick="setModelQuiz('<?=$model_quiz_id?>')">+</button>
                                                                    <label for="btn_plus_<?=$model_quiz_id?>">문항추가</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <?php
                                                    }
                                                    ?>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="tr-margin "></tr>
                        </table>
                        <table class="table-step table-step2 ">
                            <?php
                                    $grade = 2; // 피평가자 등급
                                    $use_grade_chk = (is_array($distribution_list[$grade])) ? "checked" : "";
                                    ?>
                            <tr>
                                <td>
                                    <div class="input-group">
                                                <span class="input-group-text w130 m10 border-right">
                                                    <input class="form-check-input mt-0 m5" id="use_grade<?=$grade?>_middle_model_check" name="use_grade[]" value="<?=$grade?>" type="checkbox" <?=$use_grade_chk?>>부하
                                                </span>
                                        <div class="step2-optionGroup">
                                            <span class="step2-optionGroup-label">동일배점</span>
                                            <div class="input-group points-input-group">
                                                <input type="text" name="same_distribution_grade<?=$grade?>_<?=$ii?>" class="form-control points-form" placeholder="배점입력">
                                                <button class="btn btn-outline-secondary btn-apply border-right" type="button" onclick="setDistribution('<?=$grade?>', '<?=$ii?>')">적용</button>
                                                <span class="announce">문항별 배점을 일괄 등록할 수 있습니다.</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td class="middleModelArea">
                                    <?php
                                            for($ii = 1; $ii <= 5; $ii++) {
                                                $model_quiz_id = "model_quiz_".$grade."_".$ii;
                                                $use_chk = (is_array($distribution_list[$grade][$ii])) ? "checked" : "";
                                            ?>
                                    <div class="card">
                                        <!--<button class="delete">x</button>-->
                                        <div class="card-body">
                                            <div class="card-content-wrap">
                                                <ul class="column1">
                                                    <li class="card-tit">중분류 <?=$ii?></li>
                                                    <li class="card-contents">
                                                        <input type="text" class="moddleModelTitle" value="<?=$model_list[$ii]['middle_model_name']?>" placeholder="중분류 제목" readonly />
                                                    </li>
                                                </ul>
                                                <ul class="column2">
                                                    <ul>
                                                        <li class="card-tit">문항선택</li>
                                                        <li class="card-tit">배점입력</li>
                                                    </ul>
                                                    <ul id="<?=$model_quiz_id?>">
                                                        <?php
                                                                $sub_list = $distribution_list[$grade][$ii];
                                                                if(is_array($sub_list)) {
                                                                    foreach($sub_list as $sub_quizno => $sub_distribution) {
                                                        $sub_id = "middle_model_sub_".$grade."_".$ii."_".$sub_quizno;
                                                        ?>
                                                        <div class="rows" id="<?=$sub_id?>">
                                                            <li class="card-contents1">
                                                                <input type="hidden" name="middle_model_sub_quizno[<?=$grade?>][<?=$ii?>][]" value="<?=$sub_quizno?>">
                                                                <div>
                                                                    <button class="delete" type="button" onclick="deleteModelQuiz('<?=$sub_id?>')">x</button>
                                                                    <span><?=$quiz_list[$sub_quizno]?></span>
                                                                </div>
                                                            </li>
                                                            <li class="card-contents2"><input type="text" class="txtDistributionGrade<?=$grade?>" name="distribution[<?=$grade?>][<?=$ii?>][]" value="<?=$sub_distribution?>"></li>
                                                        </div>

                                                        <?php
                                                                    }
                                                                }
                                                                ?>
                                                    </ul>
                                                </ul>
                                            </div>
                                            <div class="card-action-wrap">
                                                <div class="card-action-left">
                                                    <input type="checkbox" id="use_grade<?=$grade?>_middle_model_<?=$ii?>_check" name="use_grade<?=$grade?>_middle_model[]" value="<?=$ii?>" class="useMiddleModel" title="중분류 사용여부" <?=$use_chk?>>
                                                    <label for="use_grade<?=$grade?>_middle_model_<?=$ii?>_check">중분류 <?=$ii?>를 사용합니다</label>
                                                </div>
                                                <div class="card-action-right">
                                                    <button id="btn_plus_<?=$model_quiz_id?>" class="btn-secondary btn-plus-small" onclick="setModelQuiz('<?=$model_quiz_id?>')">+</button>
                                                    <label for="btn_plus_<?=$model_quiz_id?>">문항추가</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <?php
                                            }
                                            ?>
                                </td>
                            </tr>
                            <tr class="tr-margin "></tr>
                        </table>
                        <table class="table-step table-step2 ">
                            <?php
                                    $grade = 3; // 피평가자 등급
                                    $use_grade_chk = (is_array($distribution_list[$grade])) ? "checked" : "";
                                    ?>
                            <tr>
                                <td>
                                    <div class="input-group">
                                                <span class="input-group-text w130 m10 border-right">
                                                    <input class="form-check-input mt-0 m5" id="use_grade<?=$grade?>_middle_model_check" name="use_grade[]" value="<?=$grade?>" type="checkbox" <?=$use_grade_chk?>>동료
                                                </span>
                                        <div class="step2-optionGroup">
                                            <span class="step2-optionGroup-label">동일배점</span>
                                            <div class="input-group points-input-group">
                                                <input type="text" name="same_distribution_grade<?=$grade?>_<?=$ii?>" class="form-control points-form" placeholder="배점입력">
                                                <button class="btn btn-outline-secondary btn-apply border-right" type="button" onclick="setDistribution('<?=$grade?>', '<?=$ii?>')">적용</button>
                                                <span class="announce">문항별 배점을 일괄 등록할 수 있습니다.</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td class="middleModelArea">
                                    <?php
                                            for($ii = 1; $ii <= 5; $ii++) {
                                                $model_quiz_id = "model_quiz_".$grade."_".$ii;
                                                $use_chk = (is_array($distribution_list[$grade][$ii])) ? "checked" : "";
                                            ?>
                                    <div class="card">
                                        <!--<button class="delete">x</button>-->
                                        <div class="card-body">
                                            <div class="card-content-wrap">
                                                <ul class="column1">
                                                    <li class="card-tit">중분류 <?=$ii?></li>
                                                    <li class="card-contents">
                                                        <input type="text" class="moddleModelTitle" value="<?=$model_list[$ii]['middle_model_name']?>" placeholder="중분류 제목" readonly />
                                                    </li>
                                                </ul>
                                                <ul class="column2">
                                                    <ul>
                                                        <li class="card-tit">문항선택</li>
                                                        <li class="card-tit">배점입력</li>
                                                    </ul>
                                                    <ul id="<?=$model_quiz_id?>">
                                                        <?php
                                                                $sub_list = $distribution_list[$grade][$ii];
                                                                if(is_array($sub_list)) {
                                                                    foreach($sub_list as $sub_quizno => $sub_distribution) {
                                                        $sub_id = "middle_model_sub_".$grade."_".$ii."_".$sub_quizno;
                                                        ?>
                                                        <div class="rows" id="<?=$sub_id?>">
                                                            <li class="card-contents1">
                                                                <input type="hidden" name="middle_model_sub_quizno[<?=$grade?>][<?=$ii?>][]" value="<?=$sub_quizno?>">
                                                                <div>
                                                                    <button class="delete" type="button" onclick="deleteModelQuiz('<?=$sub_id?>')">x</button>
                                                                    <span><?=$quiz_list[$sub_quizno]?></span>
                                                                </div>
                                                            </li>
                                                            <li class="card-contents2"><input type="text" class="txtDistributionGrade<?=$grade?>" name="distribution[<?=$grade?>][<?=$ii?>][]" value="<?=$sub_distribution?>"></li>
                                                        </div>

                                                        <?php
                                                                    }
                                                                }
                                                                ?>
                                                    </ul>
                                                </ul>
                                            </div>
                                            <div class="card-action-wrap">
                                                <div class="card-action-left">
                                                    <input type="checkbox" id="use_grade<?=$grade?>_middle_model_<?=$ii?>_check" name="use_grade<?=$grade?>_middle_model[]" value="<?=$ii?>" class="useMiddleModel" title="중분류 사용여부" <?=$use_chk?>>
                                                    <label for="use_grade<?=$grade?>_middle_model_<?=$ii?>_check">중분류 <?=$ii?>를 사용합니다</label>
                                                </div>
                                                <div class="card-action-right">
                                                    <button id="btn_plus_<?=$model_quiz_id?>" class="btn-secondary btn-plus-small" onclick="setModelQuiz('<?=$model_quiz_id?>')">+</button>
                                                    <label for="btn_plus_<?=$model_quiz_id?>">문항추가</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <?php
                                            }
                                            ?>
                                </td>
                            </tr>
                            <tr class="tr-margin "></tr>
                        </table>
                        <table class="table-step table-step2 ">
                            <?php
                                    $grade = 4; // 피평가자 등급
                                    $use_grade_chk = (is_array($distribution_list[$grade])) ? "checked" : "";
                                    ?>
                            <tr>
                                <td>
                                    <div class="input-group">
                                                <span class="input-group-text w130 m10 border-right">
                                                    <input class="form-check-input mt-0 m5" id="use_grade<?=$grade?>_middle_model_check" name="use_grade[]" value="<?=$grade?>" type="checkbox" <?=$use_grade_chk?>>본인
                                                </span>
                                        <div class="step2-optionGroup">
                                            <span class="step2-optionGroup-label">동일배점</span>
                                            <div class="input-group points-input-group">
                                                <input type="text" name="same_distribution_grade<?=$grade?>_<?=$ii?>" class="form-control points-form" placeholder="배점입력">
                                                <button class="btn btn-outline-secondary btn-apply border-right" type="button" onclick="setDistribution('<?=$grade?>', '<?=$ii?>')">적용</button>
                                                <span class="announce">문항별 배점을 일괄 등록할 수 있습니다.</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td class="middleModelArea">
                                    <?php
                                            for($ii = 1; $ii <= 5; $ii++) {
                                                $model_quiz_id = "model_quiz_".$grade."_".$ii;
                                                $use_chk = (is_array($distribution_list[$grade][$ii])) ? "checked" : "";
                                            ?>
                                    <div class="card">
                                        <!--<button class="delete">x</button>-->
                                        <div class="card-body">
                                            <div class="card-content-wrap">
                                                <ul class="column1">
                                                    <li class="card-tit">중분류 <?=$ii?></li>
                                                    <li class="card-contents">
                                                        <input type="text" class="moddleModelTitle" value="<?=$model_list[$ii]['middle_model_name']?>" placeholder="중분류 제목" readonly />
                                                    </li>
                                                </ul>
                                                <ul class="column2">
                                                    <ul>
                                                        <li class="card-tit">문항선택</li>
                                                        <li class="card-tit">배점입력</li>
                                                    </ul>
                                                    <ul id="<?=$model_quiz_id?>">
                                                        <?php
                                                                $sub_list = $distribution_list[$grade][$ii];
                                                                if(is_array($sub_list)) {
                                                                    foreach($sub_list as $sub_quizno => $sub_distribution) {
                                                        $sub_id = "middle_model_sub_".$grade."_".$ii."_".$sub_quizno;
                                                        ?>
                                                        <div class="rows" id="<?=$sub_id?>">
                                                            <li class="card-contents1">
                                                                <input type="hidden" name="middle_model_sub_quizno[<?=$grade?>][<?=$ii?>][]" value="<?=$sub_quizno?>">
                                                                <div>
                                                                    <button class="delete" type="button" onclick="deleteModelQuiz('<?=$sub_id?>')">x</button>
                                                                    <span><?=$quiz_list[$sub_quizno]?></span>
                                                                </div>
                                                            </li>
                                                            <li class="card-contents2"><input type="text" class="txtDistributionGrade<?=$grade?>" name="distribution[<?=$grade?>][<?=$ii?>][]" value="<?=$sub_distribution?>"></li>
                                                        </div>

                                                        <?php
                                                                    }
                                                                }
                                                                ?>
                                                    </ul>
                                                </ul>
                                            </div>
                                            <div class="card-action-wrap">
                                                <div class="card-action-left">
                                                    <input type="checkbox" id="use_grade<?=$grade?>_middle_model_<?=$ii?>_check" name="use_grade<?=$grade?>_middle_model[]" value="<?=$ii?>" class="useMiddleModel" title="중분류 사용여부" <?=$use_chk?>>
                                                    <label for="use_grade<?=$grade?>_middle_model_<?=$ii?>_check">중분류 <?=$ii?>를 사용합니다</label>
                                                </div>
                                                <div class="card-action-right">
                                                    <button id="btn_plus_<?=$model_quiz_id?>" class="btn-secondary btn-plus-small" onclick="setModelQuiz('<?=$model_quiz_id?>')">+</button>
                                                    <label for="btn_plus_<?=$model_quiz_id?>">문항추가</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <?php
                                            }
                                            ?>
                                </td>
                            </tr>
                            <tr class="tr-margin "></tr>
                        </table>
                        <table class="table-step table-step2">
                            <tr>
                                <td>
                                    <div class="input-group">
                                        <span class="input-group-text w130 m10 border-right">가중치</span>
                                        <div class="step2-optionGroup">
                                            <div class="input-group points-input-group">
                                                <input type="text" name="same_weight" class="form-control points-form" placeholder="숫자입력" maxlength="3">
                                                <button class="btn btn-outline-secondary btn-apply border-right" type="button" onclick="setWeight()">적용</button>
                                                <span class="announce announce-light">중분류에 대한 가중치를 일괄 등록할 수 있습니다.</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <table class="table table-sm table-bordered table-hover table-weight" style="width: 55%;">
                                <thead>
                                <tr>
                                    <th scope="col" class="table-weight-tdTit"></th>
                                    <th scope="col">상사</th>
                                    <th scope="col">동료</th>
                                    <th scope="col">부하</th>
                                    <th scope="col">본인</th>
                                    <th scope="col">합계</th>
                                </tr>
                                </thead>
                                <tbody>
                                <?php
                                            unset($weight_list);
                                            if($select_idx != "") {
                                                $sql = "SELECT * FROM DM_weight WHERE idx = '$select_idx'";
                                                $result = mysqli_query($gconnet, $sql);
                                                while($row = mysqli_fetch_array($result)) {
                                                    $weight_list[$row['middle_model_index']][$row['appraisee_grade']] = $row['DM_weight'];
                                                }
                                            }
                                            for($ii = 1; $ii <= 5; $ii++) {
                                                $weight_total = $weight_list[$ii][1] + $weight_list[$ii][2] + $weight_list[$ii][3] + $weight_list[$ii][4];
                                            ?>
                                <tr>
                                    <td class="table-weight-tdTit">중분류<?=$ii?></td>
                                    <td><input type="text" class="form-control txtWeight" name="weight[<?=$ii?>][1]" value="<?=$weight_list[$ii][1]?>" model_index="<?=$ii?>" maxlength="3"></td>
                                    <td><input type="text" class="form-control txtWeight" name="weight[<?=$ii?>][2]" value="<?=$weight_list[$ii][2]?>" model_index="<?=$ii?>" maxlength="3"></td>
                                    <td><input type="text" class="form-control txtWeight" name="weight[<?=$ii?>][3]" value="<?=$weight_list[$ii][3]?>" model_index="<?=$ii?>" maxlength="3"></td>
                                    <td><input type="text" class="form-control txtWeight" name="weight[<?=$ii?>][4]" value="0" value="<?=$weight_list[$ii][4]?>" model_index="<?=$ii?>" readonly></td>
                                    <td id="weight_total_<?=$ii?>"><?=$weight_total?></td>
                                </tr>
                                <?php
                                            }
                                            ?>
                                </tbody>
                            </table>
                            <tr>
                                <td>
                                    <div class="announce announce-light">
                                        <p>
                                        <ul>
                                            <li>중분류에 대한 가중치를 입력합니다. </li>
                                            <li><span class="fontcolor-red">본인 가중치는 입력할 수 없습니다.</span></li>
                                        </ul>
                                        </p>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </section>
                </div>
                <div class="original-bg-style margin50 ">
                    <div onclick="fnScrollTop( 'section3') " class="sec_title sec_title3 contentsTop ">
                        <h2 class="stepTit ">
                            <span class="stepBadge ">STEP 3</span>
                            <br />분석옵션설정
                            <!--<i class="bi bi-bar-chart-steps "></i>-->
                        </h2>
                    </div>
                    <section id="section3">
                        <div class="infobox">
                            <div class="announce">
                                <i class="bi bi-exclamation-circle"></i>
                                <span class="fontcolor-red">원점수</span> 조사에서 적용한 점수입니다. (ex: 원점수 5점일 경우 100점으로 변환)
                            </div>
                        </div>
                        <table class="table-step table-step3 ">
                            <tr>
                                <td>
                                    <div class="input-group">
                                                <span class="input-group-text w130 m10 border-right">
                                                    점수변환방식
                                                </span>
                                        <div class="step3-optionGroup">
                                            <div class="form-check table-form-check">
                                                <input class="form-check-input" type="radio" name="score100YN" value="0" <?=($opt_info['100YN'] == 0) ? "checked" : ""?> />
                                                <label class="form-check-label m10">원점수 그대로</label>
                                            </div>
                                            <div class="form-check table-form-check">
                                                <input class="form-check-input" type="radio" name="score100YN" value="1" <?=($opt_info['100YN'] == 1) ? "checked" : ""?> />
                                                <label class="form-check-label">100점으로 변환</label>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group">
                                                <span class="input-group-text w130 m10 border-right">
                                                    원점수 기준
                                                </span>
                                        <div class="step3-optionGroup">
                                            <div class="form-check table-form-check">
                                                <input class="form-check-input" type="radio" name="indexValue" id="option_score_five " value="5" <?=($opt_info['indexValue'] == "" || $opt_info['indexValue'] == 5) ? "checked" : ""?> />
                                                <label class="form-check-label m10" for="option_score_five ">5점</label>
                                                <input class="form-check-input" type="radio" name="indexValue" id="option_score_seven " value="7" <?=($opt_info['indexValue'] == 7) ? "checked" : ""?> />
                                                <label class="form-check-label m10" for="option_score_seven ">7점</label>
                                                <input class="form-check-input" type="radio" name="indexValue" id="option_score_nine " value="9" <?=($opt_info['indexValue'] == 9) ? "checked" : ""?> />
                                                <label class="form-check-label m10" for="option_score_nine ">9점</label>
                                                <input class="form-check-input" type="radio" name="indexValue" id="option_score_ten " value="10" <?=($opt_info['indexValue'] == 10) ? "checked" : ""?> />
                                                <label class="form-check-label m10" for="option_score_ten ">10점</label>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="input-group">
                                                <span class="input-group-text w130 m10 border-right">
                                                    숫자 자리수
                                                </span>
                                        <div class="sosu">
                                            <span>소수점</span>
                                            <input type="number" class="form-control" maxlength="1" placeholder="0" name="scoreRound" value="<?=$opt_info['scoreRound']?>" id="damyun_option_scorepoint" message="점수의 소수점">
                                            <span>째 자리</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="announce announce-light">
                                        <p>
                                        <ul>
                                            <li>보고서에 출력될 숫자의 자리수를 설정합니다.</li>
                                        </ul>
                                        </p>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </section>
                </div>
            </div>
        </form>
    </main>
</div>
<?php
include "./inc/footer.html";
?>